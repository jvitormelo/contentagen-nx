---
export const prerender = true;
import { sdk, agentId } from "../contentagen";
import BaseHead from "../components/BaseHead.astro";
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
import FormattedDate from "../components/FormattedDate.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "../consts";
import { Image } from "astro:assets";
import { Button } from "@packages/ui/components/button";

const postsPerPage = 5;

// Get first page data for the index
const response = await sdk.listContentByAgent({
   agentId: [agentId],
   status: ["approved"],
   limit: postsPerPage,
   page: 1,
});
const posts = response.posts.sort(
   (a, b) => new Date(b.createdAt).valueOf() - new Date(a.createdAt).valueOf(),
);
const totalPosts = response.total;
const totalPages = Math.ceil(totalPosts / postsPerPage);
const currentPage = 1;

// Fetch images for posts that have them
const postsWithImages = await Promise.all(
   posts.map(async (post) => {
      if (post.image) {
         return post; // Already has image data
      }
      if (post.imageUrl) {
         try {
            const imageData = await sdk.getContentImage({ contentId: post.id });
            return { ...post, image: imageData };
         } catch (error) {
            console.error(`Error fetching image for post ${post.id}:`, error);
            return post;
         }
      }
      return post;
   })
);
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Navbar />
		<main class="max-w-4xl mx-auto px-4 py-12">
			<section>
				<ul class="grid gap-8 md:grid-cols-2 list-none m-0 p-0">
					{
						postsWithImages.map((post, index) => (
							<li
								class={index === 0 ? "md:col-span-2 text-center" : ""}
							>
<a href={`/${post.meta.slug}/`} class="block">
  {post.image ? (
    <img
      width={720}
      height={360}
      src={`data:${post.image.contentType};base64,${post.image.data}`}
      alt={post.meta?.title ?? ""}
      class="w-full rounded-xl mb-3 transition-shadow hover:shadow-lg aspect-video object-cover"
      loading="lazy"
    />
  ) : post.imageUrl ? (
    <Image
      width={720}
      height={360}
      src={post.imageUrl}
      alt={post.meta?.title ?? ""}
      class="w-full rounded-xl mb-3 transition-shadow hover:shadow-lg aspect-video object-cover"
      format="webp"
      loading="lazy"
    />
  ) : null}
  <h4
    class={`text-xl font-semibold leading-snug text-gray-900 dark:text-gray-100 transition-colors ${index === 0 ? "md:text-4xl" : ""}`}
  >
    {post.meta?.title ?? ""}
  </h4>
  <p class="text-sm text-gray-500">
    <FormattedDate date={ new Date(post.createdAt)} />
  </p>
</a>
							</li>
						))
					}
				</ul>
			</section>

			<!-- Pagination -->
			{totalPages > 1 && (
				<section class="mt-12 flex justify-center">
					<nav class="flex items-center space-x-2">
						{Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
							const pageNum = Math.max(1, Math.min(totalPages - 4, currentPage - 2)) + i;
							if (pageNum > totalPages) return null;
							return (
								<a href={pageNum === 1 ? "/" : `/page/${pageNum}`}>
									<Button
										variant={pageNum === currentPage ? "default" : "outline"}
										size="sm"
									>
										{pageNum}
									</Button>
								</a>
							);
						})}

						{currentPage < totalPages && (
							<a href={`/page/${currentPage + 1}`}>
								<Button variant="outline" size="sm">
									Next
								</Button>
							</a>
						)}
					</nav>
				</section>
			)}
		</main>
		<Footer />
	</body>
</html>
